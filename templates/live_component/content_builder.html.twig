<div {{ attributes }} data-controller="content-builder" class="w-full">
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
        }
    </style>
    {# Hidden input for form submission #}
    <input type="hidden" name="{{ this.inputName }}" value="{{ this.getBlocksJson() }}">

    <div class="space-y-0 max-w-5xl mx-auto px-12">
        {% for index, block in this.contentBlocks %}
        {# Insertion point BEFORE current block #}
        <div class="relative h-4 group/insert flex items-center justify-center my-4">
            <div
                class="absolute inset-x-0 h-px bg-indigo-200 dark:bg-indigo-500/20 scale-x-0 group-hover/insert:scale-x-100 transition-transform duration-300">
            </div>
            <button type="button" data-action="live#action" data-live-action-param="openPicker"
                data-live-index-param="{{ index }}"
                class="relative z-10 opacity-0 group-hover/insert:opacity-100 transition-opacity bg-white dark:bg-gray-800 rounded-full p-1 shadow-xs border border-gray-200 dark:border-white/10 text-gray-400 hover:text-indigo-600 hover:scale-110 transition-all">
                {{ ux_icon('heroicons:plus-circle-20-solid', {class: 'w-5 h-5'}) }}
            </button>
        </div>

        <div data-controller="content-block" data-content-block-id-value="{{ block.id }}"
            data-action="focusin->content-block#onFocus focusout->content-block#onBlur media-selected@window->content-block#onMediaSelected"
            class="group relative border-2 border-transparent hover:border-indigo-100 dark:hover:border-indigo-900/30 rounded-xl transition-all p-4 mb-4 bg-white dark:bg-gray-800/50 shadow-xs focus-within:z-20 focus-within:pt-16 hover:pt-16 {{ (block.data.editMode|default('visual')) == 'html' ? 'is-editing pt-16' : '' }}"
            data-block-id="{{ block.id }}">
            {# Actions Sidebar (Hover) #}
            <div
                class="absolute -left-14 top-4 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200 p-1 bg-white dark:bg-gray-900 shadow-xl border border-gray-100 dark:border-white/10 rounded-xl z-30">
                <button type="button" data-action="live#action" data-live-action-param="moveBlock"
                    data-live-id-param="{{ block.id }}" data-live-direction-param="up"
                    class="p-1.5 hover:bg-gray-100 dark:hover:bg-white/5 rounded text-gray-400 hover:text-indigo-500 transition-colors"
                    title="Move Up">
                    {{ ux_icon('heroicons:chevron-up-16-solid', {class: 'w-4 h-4'}) }}
                </button>
                <button type="button" data-action="live#action" data-live-action-param="moveBlock"
                    data-live-id-param="{{ block.id }}" data-live-direction-param="down"
                    class="p-1.5 hover:bg-gray-100 dark:hover:bg-white/5 rounded text-gray-400 hover:text-indigo-500 transition-colors"
                    title="Move Down">
                    {{ ux_icon('heroicons:chevron-down-16-solid', {class: 'w-4 h-4'}) }}
                </button>
                <div class="h-px bg-gray-100 dark:bg-white/5 mx-1 my-0.5"></div>
                <button type="button" data-action="live#action" data-live-action-param="removeBlock"
                    data-live-id-param="{{ block.id }}"
                    class="p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded text-gray-400 hover:text-red-500 transition-colors"
                    title="Delete Block">
                    {{ ux_icon('heroicons:trash-16-solid', {class: 'w-4 h-4'}) }}
                </button>
            </div>

            {# Block Type Indicator (Bottom Right) #}
            <div
                class="absolute bottom-1 right-2 opacity-0 group-hover:opacity-40 pointer-events-none transition-opacity">
                <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400 dark:text-gray-500">
                    {{ this.availableBlocks[block.type].label|default('Unknown Block (' ~ block.type ~ ')') }}
                </span>
            </div>

            {# Shared Formatting Toolbar #}
            {% if block.type != 'faq_block' %}
            {{ include('@SymkitBuilder/live_component/_editor_toolbar.html.twig', {
            block: block,
            index: index
            }) }}
            {% endif %}

            {# Actual Block Content Rendering #}
            {% set block_info = this.availableBlocks[block.type]|default(null) %}
            {% set block_template = block_info ? block_info.template : null %}
            {% if block_template %}
            {# Render Twig template - it handles its own internal data/editMode #}
            {{ include(block_template, {
            block: block,
            index: index
            }) }}
            {% else %}
            {# Fallback for blocks without a template (e.g. basic snippets or legacy blocks) #}
            <div class="p-8 border-2 border-dashed border-red-200 rounded-2xl bg-red-50/50 text-center">
                <p class="text-[10px] font-black text-red-500 uppercase tracking-[0.2em] mb-3">Orphaned Block: {{
                    block.type }}</p>
                <p class="text-xs text-red-400 mb-6 max-w-md mx-auto leading-relaxed">This block type was removed or
                    renamed. You can transform it into a <strong>Text</strong> block to keep your content.</p>

                <div class="flex items-center justify-center gap-2">
                    <button type="button" data-action="live#action text-block#onFocus"
                        data-live-action-param="transformBlock" data-live-id-param="{{ block.id }}"
                        data-live-type-param="paragraph"
                        class="px-4 py-2 bg-white border border-red-200 rounded-lg text-xs font-bold text-red-600 hover:bg-red-50 transition-colors shadow-xs focus:outline-hidden focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Transform to Text
                    </button>
                    <button type="button" data-action="live#action" data-live-action-param="removeBlock"
                        data-live-id-param="{{ block.id }}"
                        class="px-4 py-2 bg-red-500 rounded-lg text-xs font-bold text-white hover:bg-red-600 transition-colors shadow-xs focus:outline-hidden focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Remove Block
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        {# Insertion point AFTER LAST block (only if it's the last loop) #}
        {% if loop.last %}
        <div class="relative h-4 group/insert flex items-center justify-center my-4">
            <div
                class="absolute inset-x-0 h-px bg-indigo-200 dark:bg-indigo-500/20 scale-x-0 group-hover/insert:scale-x-100 transition-transform duration-300">
            </div>
            <button type="button" data-action="live#action" data-live-action-param="openPicker"
                data-live-index-param="{{ index + 1 }}"
                class="relative z-10 opacity-0 group-hover/insert:opacity-100 transition-opacity bg-white dark:bg-gray-800 rounded-full p-1 shadow-xs border border-gray-200 dark:border-white/10 text-gray-400 hover:text-indigo-600 hover:scale-110 transition-all">
                {{ ux_icon('heroicons:plus-circle-20-solid', {class: 'w-5 h-5'}) }}
            </button>
        </div>
        {% endif %}
        {% else %}
        {# Empty State #}
        <div class="text-center py-20 border-2 border-dashed border-gray-200 dark:border-white/5 rounded-xl">
            <div class="flex items-center gap-3 justify-center py-10">
                <button type="button" data-action="live#action text-block#onFocus" data-live-action-param="openPicker"
                    data-live-index-param="{{ this.contentBlocks|length }}"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all hover:scale-105 active:scale-95">
                    {{ ux_icon('heroicons:plus-circle-20-solid', {class: 'w-5 h-5'}) }}
                    <span>Add a Block</span>
                </button>

                <button type="button" data-action="live#action" data-live-action-param="openMarkdownImport"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-white/10 hover:border-indigo-300 dark:hover:border-indigo-500/50 text-gray-600 dark:text-gray-300 rounded-xl font-bold shadow-xs transition-all hover:scale-105 active:scale-95">
                    {{ ux_icon('heroicons:document-text-20-solid', {class: 'w-5 h-5 text-indigo-500'}) }}
                    <span>Import Markdown</span>
                </button>
            </div>
        </div>
        {% endfor %}

        {% if this.contentBlocks is not empty %}
        <div class="flex items-center gap-3 justify-center py-10">
            <button type="button" data-action="live#action text-block#onFocus" data-live-action-param="openPicker"
                data-live-index-param="{{ this.contentBlocks|length }}"
                class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all hover:scale-105 active:scale-95">
                {{ ux_icon('heroicons:plus-circle-20-solid', {class: 'w-5 h-5'}) }}
                <span>Add a Block</span>
            </button>

            <button type="button" data-action="live#action" data-live-action-param="openMarkdownImport"
                class="inline-flex items-center gap-2 px-6 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-white/10 hover:border-indigo-300 dark:hover:border-indigo-500/50 text-gray-600 dark:text-gray-300 rounded-xl font-bold shadow-xs transition-all hover:scale-105 active:scale-95">
                {{ ux_icon('heroicons:document-text-20-solid', {class: 'w-5 h-5 text-indigo-500'}) }}
                <span>Import Markdown</span>
            </button>
        </div>
        {% endif %}
    </div>

    {# Global Media Picker Modal #}
    {% if this.mediaPickerContext is not null %}
    <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity" data-action="click->live#action"
            data-live-action-param="closeMediaPicker"></div>

        <div
            class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-900 shadow-2xl transition-all w-full max-w-5xl p-6 h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-black text-gray-900 dark:text-white uppercase tracking-tight">Select Image</h3>
                <button type="button" data-action="live#action" data-live-action-param="closeMediaPicker"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg text-gray-400">
                    {{ ux_icon('heroicons:x-mark-20-solid', {class: 'w-5 h-5'}) }}
                </button>
            </div>
            <div class="flex-auto overflow-y-auto min-h-0">
                {{ component('media_library', {selectionMode: true, context: this.mediaPickerContext}) }}
            </div>
        </div>
    </div>
    {% endif %}

    {# Block Picker Modal #}
    {% if this.activeInsertionIndex is not null %}
    <div class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" data-action="click->live#action"
            data-live-action-param="closePicker"></div>

        <div
            class="relative transform overflow-hidden rounded-3xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-white/10 shadow-2xl transition-all w-full max-w-2xl p-8 animate-in zoom-in-95 duration-200">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white">Add a Block</h3>
                    <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest font-bold">Choose a block to insert
                    </p>
                </div>
                <button type="button" data-action="live#action" data-live-action-param="closePicker"
                    class="size-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-white/5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    {{ ux_icon('heroicons:x-mark-20-solid', {class: 'w-5 h-5'}) }}
                </button>
            </div>

            <div class="mb-6 relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    {{ ux_icon('heroicons:magnifying-glass-20-solid', {class: 'w-4 h-4 text-gray-400'}) }}
                </div>
                <input type="text" data-model="debounce(300)|blockSearch" placeholder="Search blocks..."
                    class="block w-full pl-10 pr-3 py-3 border border-gray-100 dark:border-white/5 bg-gray-50/50 dark:bg-white/[0.02] rounded-2xl text-sm placeholder-gray-400 focus:outline-hidden focus:ring-2 focus:ring-indigo-500 transition-all"
                    autofocus>
            </div>

            <div class="space-y-10 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                {% set categorizedBlocks = this.categorizedBlocks %}
                {% if categorizedBlocks is empty %}
                <div class="py-12 text-center">
                    <div
                        class="inline-flex items-center justify-center size-12 rounded-full bg-gray-50 dark:bg-white/[0.02] text-gray-400 mb-4">
                        {{ ux_icon('heroicons:face-frown-20-solid', {class: 'w-6 h-6'}) }}
                    </div>
                    <p class="text-sm text-gray-400 font-bold uppercase tracking-widest">No blocks found for "{{
                        this.blockSearch }}"</p>
                </div>
                {% endif %}

                {% for category, blocks in categorizedBlocks %}
                <div>
                    <h4
                        class="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-500 mb-4 flex items-center gap-3">
                        {{ category }}
                        <div class="h-px flex-auto bg-gray-100 dark:bg-white/5"></div>
                    </h4>
                    <div class="grid grid-cols-4 gap-3">
                        {% for type, info in blocks %}
                        <button type="button" data-action="live#action" data-live-action-param="addBlock"
                            data-live-type-param="{{ type }}"
                            class="flex flex-col items-center gap-3 p-4 rounded-2xl border border-gray-100 dark:border-white/5 bg-gray-50/50 dark:bg-white/[0.02] hover:bg-white dark:hover:bg-indigo-500/10 hover:border-indigo-100 dark:hover:border-indigo-500/20 hover:shadow-xl hover:shadow-indigo-500/10 transition-all text-center group">
                            <div
                                class="size-12 rounded-xl bg-white dark:bg-gray-800 shadow-xs border border-gray-100 dark:border-white/10 flex items-center justify-center text-gray-500 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 group-hover:scale-110 transition-all">
                                {{ ux_icon(info.icon, {class: 'w-6 h-6'}) }}
                            </div>
                            <span
                                class="text-xs font-bold text-gray-700 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{{
                                info.label }}</span>
                        </button>

                        {# Add H2-H5 shortcuts if it's the Text category #}
                        {% if type == 'paragraph' %}
                        {% for level in 2..5 %}
                        <button type="button" data-action="live#action" data-live-action-param="addBlock"
                            data-live-type-param="paragraph"
                            data-live-data-param='{{ {"content": "<h" ~ level ~ ">Heading " ~ level ~ "</h" ~ level ~ ">"}|json_encode|raw }}'
                            class="flex flex-col items-center gap-3 p-4 rounded-2xl border border-gray-100 dark:border-white/5 bg-gray-50/50 dark:bg-white/[0.02] hover:bg-white dark:hover:bg-indigo-500/10 hover:border-indigo-100 dark:hover:border-indigo-500/20 hover:shadow-xl hover:shadow-indigo-500/10 transition-all text-center group">
                            <div
                                class="size-12 rounded-xl bg-white dark:bg-gray-800 shadow-xs border border-gray-100 dark:border-white/10 flex items-center justify-center text-gray-500 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 group-hover:scale-110 transition-all">
                                {{ ux_icon('heroicons:h' ~ level ~ '-20-solid', {class: 'w-6 h-6'}) }}
                            </div>
                            <span
                                class="text-xs font-bold text-gray-700 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">Heading
                                {{ level }}</span>
                        </button>
                        {% endfor %}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {# Markdown Import Modal #}
    {% if this.isMarkdownImportOpen %}
    <div class="fixed inset-0 z-[80] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity" data-action="click->live#action"
            data-live-action-param="closeMarkdownImport"></div>

        <div
            class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-900 shadow-2xl transition-all w-full max-w-3xl p-8 flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white uppercase tracking-tight">Import
                        Markdown</h3>
                    <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest font-bold">Paste your markdown
                        content below</p>
                </div>
                <button type="button" data-action="live#action" data-live-action-param="closeMarkdownImport"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg text-gray-400">
                    {{ ux_icon('heroicons:x-mark-20-solid', {class: 'w-5 h-5'}) }}
                </button>
            </div>

            <div class="mb-6">
                <textarea data-model="markdownInput"
                    class="w-full h-80 p-6 bg-gray-50 dark:bg-black/20 text-gray-700 dark:text-gray-300 font-mono text-sm rounded-xl border border-gray-200 dark:border-white/10 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-hidden resize-none"
                    placeholder="# Your Markdown here..."></textarea>
            </div>

            <div class="flex items-center justify-end gap-3">
                <button type="button" data-action="live#action" data-live-action-param="closeMarkdownImport"
                    class="px-6 py-2.5 text-sm font-bold text-gray-500 hover:text-gray-700 dark:hover:text-white transition-colors">
                    Cancel
                </button>
                <button type="button" data-action="live#action" data-live-action-param="importMarkdown"
                    class="px-8 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-black text-sm shadow-lg shadow-indigo-200 dark:shadow-none transition-all hover:scale-105 active:scale-95 flex items-center gap-2">
                    {{ ux_icon('heroicons:bolt-20-solid', {class: 'w-4 h-4'}) }}
                    <span>Import & Transform</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>